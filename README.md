# Splendor Duel - Web Application

一个基于Vue 3 + Go + Gin的Splendor Duel桌游Web应用，支持两名玩家实时对战。

## 游戏概述

Splendor Duel是一款双人策略桌游，玩家通过收集宝石、购买发展卡、获取贵族来获得胜利。游戏支持三种胜利条件：总分达到20分、皇冠数达到10个、或某一颜色发展卡总分达到10分。

## 玩家状态

每位玩家包含以下状态信息：

- **宝石Token**: 
  - 普通宝石：白、蓝、绿、红、黑共5种
  - 珍珠：特殊宝石
  - 黄金：万能宝石，可替代任何其他宝石
- **Bonus**: 5种颜色的bonus数量（来自发展卡，永久生效）
- **保留的发展卡**: 最多3张，仅自己可见
- **特权指示物**: 最多3个，用于回合开始的可选行动
- **皇冠**: 数量，用于获取贵族和胜利条件
- **已获取的贵族**: 贵族卡ID列表
- **分数**: 来自发展卡和贵族的累计分数

## 页面构成

### 主界面布局
- **左侧**: 游戏主板图
  - 左上：宝石袋子（显示剩余宝石数量）（暂不在页面显示）
  - 左中：胜利目标提示卡（暂不在页面显示）
  - 中间：宝石版图（5x5网格，供玩家拿取宝石）
  - 右下方：贵族卡区域（开始时有4张固定贵族）
  - 右上方：发展卡区域
    - 未翻开的发展卡：3个等级各成一堆
    - 已翻开的发展卡：1/2/3级分别保持5/4/3张
  - 中间区域：特权指示物（显示公共区数量即可）

- **右侧**: 玩家状态面板
  - 显示所有玩家状态信息
  - 保留的发展卡仅自己可见
  - 当前回合状态

### 对话框与功能面板

- **可选行动对话框**: 
  - 通过点击自己的特权指示物来触发「花费特权指示物」（以拿取宝石）对话框，对话框提示玩家要拿取哪个/哪些宝石
  - 通过点击场上的袋子来触发「补充版图」对话框，对话框提示玩家是否确认补充版图
- **强制行动对话框**：
  - 通过点击宝石版图的宝石来触发「拿取宝石」对话框，对话框提示玩家要拿取哪些宝石
  - 通过点击宝石版图的黄金来触发「保留发展卡」对话框，对话框提示玩家要保留哪张发展卡
  - 通过点击已经翻开的发展卡/保留区域的发展卡来触发「购买发展卡」对话框，对话框提示玩家要花费哪些宝石来购买这张发展卡
- **特殊效果对话框**：
  - 当玩家购买了「百搭颜色」效果的卡牌后，对话框提示玩家要选择哪种颜色放置这张卡
  - 当玩家购买了「额外token」效果的卡牌后，对话框提示玩家拿走版图上一个对应颜色的token
  - 当玩家购买了「窃取」效果的卡牌，或选择 ID 为 noble1 的贵族后，对话框提示玩家窃取对手的一个非黄金token
  - 当玩家的皇冠首次达到3和6时，对话框提示玩家选择一个可获得的贵族，获得其分数和效果
- **游戏记录**: 记录所有操作历史
- **聊天功能**: 两名玩家实时交流

## 发展卡说明

### 卡牌类型

- **普通卡**: 65张，分为3个等级
  - 1级：基础卡，费用较低
  - 2级：中级卡，费用中等
  - 3级：高级卡，费用较高

- **特殊卡**: 包括百搭颜色和灰色卡

### 费用计算

- 使用 `ZXCVB` 轮盘计算所有普通卡的费用
- 特殊卡的费用单独标示
- 详情见 `cards.go`

### 卡牌效果

- **永久效果**：
  - 分数，胜利条件之一
  - bonus，后续购买发展卡时享受优惠
  - 皇冠，胜利条件之一，还可以获得贵族
- **一次性效果**：
  - 额外token：从宝石版图拿一个与卡牌颜色相同的token
  - 新的回合：下一个回合仍然是自己的回合
  - 获取特权：从公共区获得特权指示物，若没有，则从对手处获得特权指示物
  - 百搭颜色：可以将该卡视为选定颜色的卡，提供选定颜色的bonus
  - 窃取：从对手处窃取一个非黄金宝石

## 游戏流程

### 游戏开始

1. 随机决定起始玩家
2. 后手玩家获得1个特权指示物作为补偿
3. 初始化宝石版图：5种颜色各4个、珍珠2个、黄金3个
4. 4张贵族卡放置在场上

### 回合流程

每名玩家的回合包含以下阶段：

#### 可选行动（0-2种）
1. **花费特权指示物**: 消耗特权指示物拿取宝石（不能选择黄金）
2. **补充版图**: 从袋子补充宝石到版图，对手获得特权指示物

#### 强制行动（必须选择1种）
1. **拿取宝石**: 选择1-3个宝石，必须在同一直线上（横、竖、斜皆可）且连续，不能包含黄金
2. **购买发展卡**: 选择场上翻开的发展卡或自己保留的卡，花费宝石购买
3. **保留发展卡**: 选择一张卡保留，同时获得黄金（需要版图上有黄金）

### 回合结束检查

1. **贵族获取**: 皇冠数达到3或6时，选择一个贵族获得
2. **宝石限制**: 如果宝石总数超过10，必须丢弃到10个
3. **空位补充**: 如果购买/保留了翻开的卡，从对应等级牌堆补充
4. **胜利检查**: 检查是否达成任一胜利条件

### 胜利条件
1. 总分达到20分
2. 皇冠数达到10个
3. 某一颜色发展卡总分达到10分

## 后端项目结构

```
backend/
├── cmd/
│   └── main.go                # 程序入口点
├── internal/
│   ├── models/
│   │   └── types.go           # 数据模型定义
│   ├── game/
│   │   ├── cards.go           # 卡牌数据和费用计算
│   │   ├── game_logic.go      # 核心游戏逻辑
│   │   └── manager.go         # 房间和游戏管理
│   ├── websocket/
│   │   └── handler.go         # WebSocket消息处理
│   └── api/
│       └── routes.go          # HTTP路由定义
├── go.mod                     # Go模块依赖
└── go.sum                     # 依赖校验和
```

### 核心组件
- **GameLogic**: 管理游戏状态和规则
- **CardManager**: 处理卡牌生成和费用计算
- **RoomManager**: 管理游戏房间和玩家
- **WebSocketHandler**: 处理实时通信

## 前端项目结构

```
frontend/
├── public/
│   └── images/                # 游戏图片资源
│       ├── gems/              # 宝石图片
│       ├── cards/             # 发展卡图片
│       └── nobles/            # 贵族卡图片
├── src/
│   ├── components/
│   │   ├── GameBoard.vue      # 游戏主面板
│   │   ├── GameActionPanel.vue # 操作按钮面板
│   │   ├── GameNotification.vue # 通知组件
│   │   └── ActionDialog.vue   # 操作确认对话框
│   ├── views/
│   │   ├── Home.vue           # 首页（房间创建/加入）
│   │   └── Game.vue           # 游戏主界面
│   ├── stores/
│   │   └── game.js            # Pinia状态管理
│   ├── router/
│   │   └── index.js           # Vue Router配置
│   ├── App.vue                # 根组件
│   └── main.js                # 应用入口
├── package.json               # 项目依赖配置
└── vite.config.js             # Vite构建配置
```

### 技术栈
- **Vue 3**: 使用Composition API
- **Pinia**: 状态管理
- **Vue Router**: 路由管理
- **Vite**: 构建工具
- **Axios**: HTTP客户端
- **WebSocket**: 实时通信

### 核心功能
- **响应式游戏界面**: 实时显示游戏状态
- **操作确认对话框**: 支持所有游戏操作
- **实时通信**: WebSocket连接后端
- **状态管理**: 集中管理游戏数据
- **路由系统**: 支持房间创建和游戏页面

## 图片资源说明

详细的图片资源格式说明请参考 `frontend/public/images/README.md`。

## 运行说明

### 后端启动
```bash
cd backend
go run cmd/main.go
```

### 前端启动
```bash
cd frontend
npm install
npm run dev
```

### 游戏流程
1. 访问首页，输入房间名和玩家名
2. 创建或加入房间
3. 房间满2名玩家加入后，游戏自动初始化并开始
4. 房间创建后24小时后自动销毁以释放资源

## 开发状态

当前版本已实现：
- ✅ 入口界面，支持创建房间或加入房间
- ✅ 两名玩家加入后自动初始化游戏
- ✅ 游戏版图的各个元素均可触发交互逻辑
- ✅ 实现了补充版图操作
- ✅ 实现了拿取宝石操作
- ✅ 实现了保留（预购）发展卡操作
- ✅ 实现了购买发展卡操作
- ✅ 实现了丢弃宝石操作
- ✅ 完善拿取特权指示物逻辑
- ✅ 为补充版图操作增加确认对话框
- ✅ 在拿取宝石操作对话框增加让对手拿取特权指示物的提示
- ✅ 通过对话框实现使用特权指示物操作
- ✅ 实现可选动作与强制动作的顺序限制
- ✅ 解决重新进入房间问题
- ✅ 实现发展卡效果 - 获取特权
- ✅ 实现发展卡效果 - 新的回合
- ✅ 实现发展卡效果 - 额外token
- ✅ 实现发展卡效果 - 窃取
- ✅ 实现发展卡效果 - 百搭颜色
- ✅ 实现对购买百搭颜色卡的条件检查
- ✅ 通过对话框实现选择贵族操作

待完善功能：
- 🟠 实现贵族效果结算
- 🟠 补充双bonus发展卡效果
- 🟠 修复后端 213 不在直线上问题
- 🟠 实现游戏胜利条件检查
- 🟠 实现操作记录
- 🟠 实现对话功能
- 🟠 功能与UI优化